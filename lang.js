/* ========== –Ø–∑—ã–∫–æ–≤–æ–π —Ñ–∞–π–ª ========== */

const translations = {
  pl: {
    langBtn: 'üáµüá± PL',
    backBtn: '‚Üê Wstecz',
    backBtnText: 'Wstecz',
    previewBtn: 'üîç PodglƒÖd',
    collageBtn: 'üß© Utw√≥rz kola≈º',
    settings: 'Ustawienia',
    logoLabel: 'Logo (PNG/JPG/SVG)',
    logoSizeLabel: 'Rozmiar logo: ',
    bgShapeLabel: 'T≈Ço pod logo:',
    circle: 'Ko≈Ço',
    rectangle: 'ProstokƒÖt',
    none: 'Brak',
    codesList: 'Lista kod√≥w',
    code: 'Kod',
    color: 'Kolor',
    addRow: '+ Dodaj wiersz',
    downloadAll: 'üíæ Pobierz wszystkie PNG',
    collageHint: 'Aby utworzyƒá kola≈º, wybierz kartƒô w oknie "Utw√≥rz kola≈º" (kliknij kartƒô).',
    gallery: 'Galeria kart',
    chooseColor: 'Wybierz kolor:',
    collageTitle: 'Kola≈º A4 (4 kwadranty)',
    selected: 'Wybrane: 0/4',
    cutGapLabel: 'Strefa ciƒôcia (mm):',
    close: '‚úñ Zamknij',
    collageHint2: 'Kola≈º jest wy≈õwietlany bez rozciƒÖgania, z zachowaniem proporcji.',
    reset: 'üóë Resetuj',
    savePng: 'üíæ Zapisz PNG',
    selectedCard: 'Wybrano',
    placeholder: 'Kod (np: F3-WMT-000-000-001)',
    deleteRow: 'Usu≈Ñ wiersz',
    paletteTitle: 'Wybierz kolor z palety'
  },
  en: {
    langBtn: 'üá¨üáß EN',
    backBtn: '‚Üê Back',
    backBtnText: 'Back',
    previewBtn: 'üîç Preview',
    collageBtn: 'üß© Create Collage',
    settings: 'Settings',
    logoLabel: 'Logo (PNG/JPG/SVG)',
    logoSizeLabel: 'Logo size: ',
    bgShapeLabel: 'Background shape:',
    circle: 'Circle',
    rectangle: 'Rectangle',
    none: 'None',
    codesList: 'Code List',
    code: 'Code',
    color: 'Color',
    addRow: '+ Add Row',
    downloadAll: 'üíæ Download All PNG',
    collageHint: 'To create a collage, select cards in the "Create Collage" window (click on card).',
    gallery: 'Card Gallery',
    chooseColor: 'Choose color:',
    collageTitle: 'A4 Collage (4 Quadrants)',
    selected: 'Selected: 0/4',
    cutGapLabel: 'Cut zone (mm):',
    close: '‚úñ Close',
    collageHint2: 'Collage is displayed without stretching, keeping proportions.',
    reset: 'üóë Reset',
    savePng: 'üíæ Save PNG',
    selectedCard: 'Selected',
    placeholder: 'Code (e.g: F3-WMT-000-000-001)',
    deleteRow: 'Delete row',
    paletteTitle: 'Select color from palette'
  },
  uk: {
    langBtn: 'üá∫üá¶ UA',
    backBtn: '‚Üê –ù–∞–∑–∞–¥',
    backBtnText: '–ù–∞–∑–∞–¥',
    previewBtn: 'üîç –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥',
    collageBtn: 'üß© –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–ª–∞–∂',
    settings: '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è',
    logoLabel: '–õ–æ–≥–æ—Ç–∏–ø (PNG/JPG/SVG)',
    logoSizeLabel: '–†–æ–∑–º—ñ—Ä –ª–æ–≥–æ—Ç–∏–ø—É: ',
    bgShapeLabel: '–§–æ–Ω –ø—ñ–¥ –ª–æ–≥–æ—Ç–∏–ø–æ–º:',
    circle: '–ö–æ–ª–æ',
    rectangle: '–ü—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫',
    none: '–ù–µ–º–∞—î',
    codesList: '–°–ø–∏—Å–æ–∫ –∫–æ–¥—ñ–≤',
    code: '–ö–æ–¥',
    color: '–ö–æ–ª—ñ—Ä',
    addRow: '+ –î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫',
    downloadAll: 'üíæ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ PNG',
    collageHint: '–©–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–ª–∞–∂, –≤–∏–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç–∫–∏ —É –≤—ñ–∫–Ω—ñ "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–ª–∞–∂" (–∫–ª—ñ–∫–Ω—ñ—Ç—å –ø–æ –∫–∞—Ä—Ç—Ü—ñ).',
    gallery: '–ì–∞–ª–µ—Ä–µ—è –∫–∞—Ä—Ç–æ–∫',
    chooseColor: '–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä:',
    collageTitle: '–ö–æ–ª–∞–∂ –ê4 (4 –∫–≤–∞–¥—Ä–∞–Ω—Ç–∏)',
    selected: '–í–∏–±—Ä–∞–Ω–æ: 0/4',
    cutGapLabel: '–ó–æ–Ω–∞ —Ä—ñ–∑–∞–Ω–Ω—è (–º–º):',
    close: '‚úñ –ó–∞–∫—Ä–∏—Ç–∏',
    collageHint2: '–ö–æ–ª–∞–∂ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –±–µ–∑ —Ä–æ–∑—Ç—è–≥—É–≤–∞–Ω–Ω—è, –∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π.',
    reset: 'üóë –°–∫–∏–Ω—É—Ç–∏',
    savePng: 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ PNG',
    selectedCard: '–í–∏–±—Ä–∞–Ω–æ',
    placeholder: '–ö–æ–¥ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: F3-WMT-000-000-001)',
    deleteRow: '–í–∏–¥–∞–ª–∏—Ç–∏ —Ä—è–¥–æ–∫',
    paletteTitle: '–í–∏–±—Ä–∞—Ç–∏ –∫–æ–ª—ñ—Ä –∑ –ø–∞–ª—ñ—Ç—Ä–∏'
  }
};

// –°–ø–∏—Å–æ–∫ —è–∑—ã–∫–æ–≤ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ dropdown
const languages = [
  { code: 'pl', name: 'Polski', flag: 'pl' },
  { code: 'en', name: 'English', flag: 'gb' },
  { code: 'uk', name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞', flag: 'ua' }
];

let currentLang = localStorage.getItem('qrLang') || 'pl';
let langDropdownOpen = false;

function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('qrLang', lang);
  document.documentElement.lang = lang;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º flag-icons)
  const langBtn = document.getElementById('langBtn');
  const langInfo = languages.find(l => l.code === lang);
  if (langInfo) {
    langBtn.innerHTML = `<span class="fi fi-${langInfo.flag}" style="margin-right:6px"></span>${langInfo.code.toUpperCase()}`;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[lang][key] !== undefined) {
      el.textContent = translations[lang][key];
    }
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º placeholder
  const codeInput = document.querySelector('#codeTable tbody input[type="text"]');
  if (codeInput) {
    codeInput.placeholder = translations[lang].placeholder;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º select options
  document.querySelectorAll('#bgShape option').forEach(opt => {
    const key = opt.getAttribute('data-i18n');
    if (key && translations[lang][key]) {
      opt.textContent = translations[lang][key];
    }
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º popup –ø–∞–ª–∏—Ç—Ä—ã
  const palTitle = document.querySelector('#paletteTemplate .pal-title');
  if (palTitle) {
    palTitle.textContent = translations[lang].chooseColor + ':';
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
  updateSelectedInfo();
  
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º picker –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
  if (typeof renderPicker === 'function') {
    renderPicker();
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º lightbox
  const lbClose = document.querySelector('.lb-close');
  if (lbClose) lbClose.textContent = '‚úï';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º active —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ dropdown
  updateDropdownActive();
}

function toggleLanguageDropdown(e) {
  e.stopPropagation();
  const dropdown = document.getElementById('langDropdown');
  langDropdownOpen = !langDropdownOpen;
  
  if (langDropdownOpen) {
    dropdown.classList.add('show');
  } else {
    dropdown.classList.remove('show');
  }
}

function closeLanguageDropdown() {
  const dropdown = document.getElementById('langDropdown');
  langDropdownOpen = false;
  if (dropdown) dropdown.classList.remove('show');
}

function selectLanguage(langCode) {
  setLanguage(langCode);
  closeLanguageDropdown();
}

function updateDropdownActive() {
  const items = document.querySelectorAll('.lang-dropdown-item');
  items.forEach(item => {
    if (item.dataset.lang === currentLang) {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
}

function t(key) {
  return translations[currentLang][key] || key;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
function updateSelectedInfo() {
  const count = typeof selectedSet !== 'undefined' ? selectedSet.size : 0;
  const text = t('selected').replace('0', count).replace('4', '4');
  const infoEl = document.getElementById('selectedInfo');
  if (infoEl) {
    const langKey = currentLang === 'pl' ? 'Wybrane: ' : 
                    currentLang === 'en' ? 'Selected: ' : 
                    '–í–∏–±—Ä–∞–Ω–æ: ';
    infoEl.textContent = langKey + count + '/4';
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–∞–π–ª–µ
if (typeof window !== 'undefined') {
  window.translations = translations;
  window.languages = languages;
  window.currentLang = currentLang;
  window.setLanguage = setLanguage;
  window.toggleLanguageDropdown = toggleLanguageDropdown;
  window.closeLanguageDropdown = closeLanguageDropdown;
  window.selectLanguage = selectLanguage;
  window.t = t;
  window.updateSelectedInfo = updateSelectedInfo;
}

// –ó–∞–∫—Ä—ã—Ç—å dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', function(e) {
  if (langDropdownOpen && !e.target.closest('.lang-dropdown-wrapper')) {
    closeLanguageDropdown();
  }
});
